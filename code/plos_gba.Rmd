---
output:
  html_document:
    keep_md: true
---

# PLOS in Saskatoon - Gender-based analysis and Correlation with Diabetes

## 1. Gender proportion by DA

```{r}
library(cancensus)
library(dplyr)
library(sf)
library(stringr)
library(purrr)
library(RColorBrewer)
library(ggplot2)
library(scales)
library(readxl)
library(tidyr)

dataset <- "CA21"
```

No vectors with only sex or gender at DA-level, so I will add up the male/female age groups. 

```{r}
vecs <- c(
  total      = "v_CA21_1",
  male_0_14  = "v_CA21_12",
  fem_0_14   = "v_CA21_13",
  male_15_64 = "v_CA21_69",
  fem_15_64  = "v_CA21_70",
  male_65p   = "v_CA21_252",
  fem_65p    = "v_CA21_253"
)
```

```{r}
sex_da_raw <- get_census(
  dataset    = "CA21",
  regions    = list(CMA = "47725"),
  level      = "DA",
  vectors    = unname(vecs),
  geo_format = NA, # only data frame
  use_cache  = TRUE
)
```

Standardizing names to raw vector IDs (since the actual vector names are longer and turns up an error) -> dropping the labels after the colon. 

```{r}
sex_da_std <- sex_da_raw %>%
  rename(DAUID = GeoUID) %>%
  rename_with(~ sub("^((v_CA21_\\d+)).*$", "\\1", .x))
```

Building totals & proportions:

```{r}
sex_da <- sex_da_std %>%
  transmute(
    DAUID       = as.character(DAUID),
    total       = as.numeric(.data[[vecs["total"]]]),
    male_total  = as.numeric(.data[[vecs["male_0_14"]]])  +
                  as.numeric(.data[[vecs["male_15_64"]]]) +
                  as.numeric(.data[[vecs["male_65p"]]]),
    fem_total   = as.numeric(.data[[vecs["fem_0_14"]]])   +
                  as.numeric(.data[[vecs["fem_15_64"]]])  +
                  as.numeric(.data[[vecs["fem_65p"]]])
  ) %>%
  mutate(
    prop_men   = dplyr::if_else(total > 0, male_total / total, NA_real_),
    prop_women = dplyr::if_else(total > 0, fem_total  / total, NA_real_)
  )

sex_da
```

Summary of sex by DA:

```{r}
summary(sex_da$prop_women)
```

## 2. Mapping sex by DA

```{r}
# plos code
ped_path <- "/Users/patysalazar/Desktop/MSc/PLOS/plos/required_files/Saskatoon_ped_1.shp"
da_path <- "/Users/patysalazar/Desktop/MSc/PLOS/plos/required_files/lda_000b21a_e/lda_000b21a_e.shp"

ped <- st_read(ped_path, quiet = TRUE)
da_poly <- st_read(da_path, quiet = TRUE) |>
  select(DAUID, PRUID, geometry) |>
  filter(PRUID == "47")  

ped <- st_transform(ped, crs = 3857) 
da_poly <- st_transform(da_poly, crs = 3857)

ped <- ped |>
  mutate(
    Walk_Width = ifelse(Walk_Width %in% c("99999", 99999, "<Null>"), NA, Walk_Width) |> as.numeric(),
    Walk_Mater = ifelse(Walk_Mater %in% c("<Null>", "0", 0, "9", 9), NA, Walk_Mater) |> as.integer()
  )

score_type <- function(x){
  case_when(
    x == "Walkway"  ~ 3,
    x == "Separate" ~ 3,
    x == "Pathway"  ~ 2,
    x == "Combined" ~ 1,
    TRUE            ~ 1
  )
}

score_width <- function(w){
  case_when(
    is.na(w)  ~ 0,
    w <  1    ~ 0,
    w <  1.5  ~ 1,
    w <  2.5  ~ 2,
    w <  3    ~ 3,
    TRUE      ~ 4
  )
}

score_material <- function(c){
  case_when(
    c %in% c(1, 2, 10) ~ 3,            
    c %in% c(3, 4)     ~ 2,            
    c %in% c(5, 7)     ~ 1,            
    c == 6 | is.na(c)  ~ 0,            
    TRUE               ~ 0
  )
}

ped_scored <- ped |>
  mutate(
    sc_type  = score_type(Walk_Type_),           
    sc_width = score_width(Walk_Width),
    sc_mat   = score_material(Walk_Mater),
    q_score  = sc_type + sc_width + sc_mat,      
    seg_km   = SHAPE_Leng / 1000,                
    wtd_val  = q_score * seg_km,
    density  = wtd_val / (LANDAREA)        
  )

da_scores <- ped_scored |>
  st_drop_geometry() |>
  group_by(DAUID) |>
  summarise(plos_density = sum(density, na.rm = TRUE), .groups = "drop")
```

DA IDs used in PLOS analysis

```{r}
keep_ids <- as.character(unique(da_scores$DAUID))
```

Getting DA polygons from Saskatoon CMA

```{r}
das_cma_raw <- get_census(
  dataset    = "CA21",
  regions    = list(CMA = "47725"),
  level      = "DA",
  geo_format = "sf",
  use_cache  = TRUE
)
```

Creating DAUID column 

```{r}
id_candidates <- c("DAUID","GeoUID","Geo_UID","DA_UID")
id_col <- id_candidates[id_candidates %in% names(das_cma_raw)][1]
stopifnot(!is.na(id_col))

keep_ids <- as.character(unique(da_scores$DAUID))
```

Target CRS = whatever ped is in (3857).

```{r}
target_crs <- st_crs(ped)
```

Make sure the DA layer is in the same CRS

```{r}
das_cma <- das_cma_raw |>
  mutate(DAUID = as.character(.data[[id_col]])) |>
  st_transform(target_crs)
```

Keep only DAs analyzed

```{r}
das_keep <- das_cma |> filter(DAUID %in% keep_ids)
```

Join sex proportions 

```{r}
gender_keep <- das_keep |>
  left_join(sex_da, by = "DAUID") |>
  st_transform(target_crs)
```

Build bbox from the ped layer

```{r}
bbox_sask_sf <- st_as_sfc(st_bbox(ped))  
```

Crop

```{r}
gender_keep <- st_make_valid(gender_keep) # fix any invalid geometries
gender_keep <- st_crop(gender_keep, bbox_sask_sf)
```

Plot 

```{r}
gender_da_map <- ggplot(gender_keep) +
  geom_sf(aes(fill = prop_women), color = NA) +
  scale_fill_distiller(
    type = "div", palette = "Reds", direction = -1,
    limits = c(0.40, 0.60), oob = squish,
    labels = percent_format(accuracy = 1),
    name = "Women (%)"
  ) +
  coord_sf(xlim = st_bbox(ped)[c("xmin","xmax")],
           ylim = st_bbox(ped)[c("ymin","ymax")],
           expand = FALSE) +
  labs(title = "Proportion of Women by Dissemination Area",
       subtitle = "Saskatoon",
       caption = "Data: Statistics Canada, Census 2021 (Sex at birth)") +
  theme_void() +
  theme(legend.position = "bottom")

ggsave("/Users/patysalazar/Desktop/Methods Café/Final Paper/plos_project/maps/gender_da_map.png",
       plot = gender_da_map, width = 8, height = 6, dpi = 300,
       bg = "white")
```

## 3. Mapping diabetes data (by DA and gender)

```{r}
health_data_path <- "/Users/patysalazar/Desktop/Methods Café/Final Paper/plos_project/required_files/Raw data for hospitalizations_for_Paty.xlsx"
```

```{r}
health_data <- read_excel(
  path = health_data_path,
  sheet = "Diabetes"  
)

names(health_data)
```

Renaming da to DAUID

```{r}
health_data <- health_data %>%
  mutate(da = as.character(da)) %>%
  rename(DAUID = da)
```

Overall cases by DA

```{r}
cases_da <- health_data %>%
  group_by(DAUID) %>%
  summarise(cases_all = n())

cases_da_sex <- health_data %>%
  filter(gender %in% c("Male","Female")) %>%
  count(DAUID, gender, name = "cases") %>%
  ungroup()
```

Overall denominator per DA

```{r}
den_all <- sex_da %>% select(DAUID, pop_all = total)
```

Sex-specific denominator per DA

```{r}
den_sex <- sex_da %>%
  transmute(
    DAUID,
    Male   = male_total,
    Female = fem_total
  ) %>%
  pivot_longer(c(Male, Female), names_to="gender", values_to="pop")
```

Overall prevalence by DA

```{r}
prev_da <- cases_da %>%
  left_join(den_all, by = "DAUID") %>%
  mutate(prev_all = if_else(pop_all > 0, cases_all / pop_all, NA_real_))

prev_da
```

Sex-specific prevalence by DA

```{r}
prev_da_sex <- cases_da_sex %>%
  left_join(den_sex, by = c("DAUID","gender")) %>%
  mutate(prev = if_else(pop > 0, cases / pop, NA_real_))
```

Joining datasets by DA

```{r}
da_diabetes <- das_keep %>%
  left_join(health_data, by = "DAUID") 
```

Overall prevalence map

```{r}
da_diab_all <- das_keep %>%
  left_join(prev_da, by = "DAUID")

ggplot(da_diab_all) +
  geom_sf(aes(fill = prev_all), color = NA) +
  scale_fill_viridis_c(labels = percent_format(accuracy = 0.1),
                       name = "Diabetes prevalence") +
  coord_sf(
    xlim = st_bbox(ped)[c("xmin","xmax")],
    ylim = st_bbox(ped)[c("ymin","ymax")],
    expand = FALSE
  ) +
  labs(title = "Diabetes Prevalence by DA (All)",
       subtitle = "Saskatoon") +
  theme_void() + theme(legend.position = "bottom")
```

Sex-specific maps

Splitting into 2 datasets

```{r}
# keep only male/female rows from sex-specific prevalence sf
da_diab_sex2 <- da_diab_sex %>%
  filter(gender %in% c("Male","Female"))

# common limits across both maps 
lims <- range(da_diab_sex2$prev, na.rm = TRUE)
lims[1] <- 0
lims[2] <- max(lims[2], 0.15)   # 15% cap

# split
da_diab_male   <- da_diab_sex2 %>% filter(gender == "Male")
da_diab_female <- da_diab_sex2 %>% filter(gender == "Female")
```

Male map (diabetes by DA)

```{r}
p_male <- ggplot(da_diab_male) +
  geom_sf(aes(fill = prev), color = NA) +
  scale_fill_viridis_c(
    limits = lims, oob = squish,
    labels = percent_format(accuracy = 0.1),
    name = "Diabetes prevalence",
    na.value = "grey80"  
  ) +
  coord_sf(
    xlim = st_bbox(ped)[c("xmin","xmax")],
    ylim = st_bbox(ped)[c("ymin","ymax")],
    expand = FALSE
  ) +
  labs(
    title = "Diabetes Prevalence by DA — Male",
    subtitle = "Saskatoon"
  ) +
  theme_void() +
  theme(legend.position = "bottom")

print(p_male)
```

Female map (diabetes by DA)

```{r}
p_female <- ggplot(da_diab_female) +
  geom_sf(aes(fill = prev), color = NA) +
  scale_fill_viridis_c(
    limits = lims, oob = squish,
    labels = percent_format(accuracy = 0.1),
    name = "Diabetes prevalence",
    na.value = "grey80"
  ) +
  coord_sf(
    xlim = st_bbox(ped)[c("xmin","xmax")],
    ylim = st_bbox(ped)[c("ymin","ymax")],
    expand = FALSE
  ) +
  labs(
    title = "Diabetes Prevalence by DA — Female",
    subtitle = "Saskatoon"
  ) +
  theme_void() +
  theme(legend.position = "bottom")

print(p_female)
```


## 4. Correlation analysis













