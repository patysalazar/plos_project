---
output:
  html_document:
    keep_md: true
---

# PLOS in Saskatoon - Gender-based analysis and Correlation with Diabetes

## 1. Gender proportion by DA

```{r}
library(cancensus)
library(dplyr)
library(sf)
library(stringr)
library(purrr)
library(RColorBrewer)
library(ggplot2)
library(scales)
library(readxl)
library(tidyr)
library(stats)

dataset <- "CA21"
```

No vectors with only gender or gender at DA-level, so I will add up the men/women age groups. 

```{r}
vecs <- c(
  total      = "v_CA21_1",
  men_0_14  = "v_CA21_12",
  fem_0_14   = "v_CA21_13",
  men_15_64 = "v_CA21_69",
  fem_15_64  = "v_CA21_70",
  men_65p   = "v_CA21_252",
  fem_65p    = "v_CA21_253"
)
```

```{r}
gender_da_raw <- get_census(
  dataset    = "CA21",
  regions    = list(CMA = "47725"),
  level      = "DA",
  vectors    = unname(vecs),
  geo_format = NA, # only data frame
  use_cache  = TRUE
)
```

Standardizing names to raw vector IDs (since the actual vector names are longer and turns up an error) -> dropping the labels after the colon. 

```{r}
gender_da_std <- gender_da_raw %>%
  rename(DAUID = GeoUID) %>%
  rename_with(~ sub("^((v_CA21_\\d+)).*$", "\\1", .x))
```

Building totals & proportions:

```{r}
gender_da <- gender_da_std %>%
  transmute(
    DAUID       = as.character(DAUID),
    total       = as.numeric(.data[[vecs["total"]]]),
    men_total  = as.numeric(.data[[vecs["men_0_14"]]])  +
                  as.numeric(.data[[vecs["men_15_64"]]]) +
                  as.numeric(.data[[vecs["men_65p"]]]),
    fem_total   = as.numeric(.data[[vecs["fem_0_14"]]])   +
                  as.numeric(.data[[vecs["fem_15_64"]]])  +
                  as.numeric(.data[[vecs["fem_65p"]]])
  ) %>%
  mutate(
    prop_men   = if_else(total > 0, men_total / total, NA_real_),
    prop_women = if_else(total > 0, fem_total  / total, NA_real_)
  )

gender_da
```

Summary of gender by DA:

```{r}
summary(gender_da$prop_women)
summary(gender_da$prop_men)
```

## 2. Mapping gender by DA

```{r}
# plos code
ped_path <- "/Users/patysalazar/Desktop/MSc/PLOS/plos/required_files/Saskatoon_ped_1.shp"
da_path <- "/Users/patysalazar/Desktop/MSc/PLOS/plos/required_files/lda_000b21a_e/lda_000b21a_e.shp"

ped <- st_read(ped_path, quiet = TRUE)
da_poly <- st_read(da_path, quiet = TRUE) |>
  select(DAUID, PRUID, geometry) |>
  filter(PRUID == "47")  

ped <- st_transform(ped, crs = 3857) 
da_poly <- st_transform(da_poly, crs = 3857)

ped <- ped |>
  mutate(
    Walk_Width = ifelse(Walk_Width %in% c("99999", 99999, "<Null>"), NA, Walk_Width) |> as.numeric(),
    Walk_Mater = ifelse(Walk_Mater %in% c("<Null>", "0", 0, "9", 9), NA, Walk_Mater) |> as.integer()
  )

score_type <- function(x){
  case_when(
    x == "Walkway"  ~ 3,
    x == "Separate" ~ 3,
    x == "Pathway"  ~ 2,
    x == "Combined" ~ 1,
    TRUE            ~ 1
  )
}

score_width <- function(w){
  case_when(
    is.na(w)  ~ 0,
    w <  1    ~ 0,
    w <  1.5  ~ 1,
    w <  2.5  ~ 2,
    w <  3    ~ 3,
    TRUE      ~ 4
  )
}

score_material <- function(c){
  case_when(
    c %in% c(1, 2, 10) ~ 3,            
    c %in% c(3, 4)     ~ 2,            
    c %in% c(5, 7)     ~ 1,            
    c == 6 | is.na(c)  ~ 0,            
    TRUE               ~ 0
  )
}

ped_scored <- ped |>
  mutate(
    sc_type  = score_type(Walk_Type_),           
    sc_width = score_width(Walk_Width),
    sc_mat   = score_material(Walk_Mater),
    q_score  = sc_type + sc_width + sc_mat,      
    seg_km   = SHAPE_Leng / 1000,                
    wtd_val  = q_score * seg_km,
    density  = wtd_val / (LANDAREA)        
  )

da_scores <- ped_scored |>
  st_drop_geometry() |>
  group_by(DAUID) |>
  summarise(plos_density = sum(density, na.rm = TRUE), .groups = "drop")
```

DA IDs used in PLOS analysis

```{r}
keep_ids <- as.character(unique(da_scores$DAUID))
```

Getting DA polygons from Saskatoon CMA

```{r}
das_cma_raw <- get_census(
  dataset    = "CA21",
  regions    = list(CMA = "47725"),
  level      = "DA",
  geo_format = "sf",
  use_cache  = TRUE
)
```

```{r}
names(das_cma_raw)
```

Target CRS = whatever ped is in (3857) -> aligning CRS

```{r}
target_crs <- st_crs(ped)
```

Make sure the DA layer is in the same CRS

```{r}
das_cma <- das_cma_raw %>%
  mutate(DAUID = as.character(.data[["GeoUID"]])) |>
  st_transform(target_crs)
```

Keep only DAs analyzed

```{r}
das_keep <- das_cma %>% filter(DAUID %in% keep_ids)
```

Join gender proportions 

```{r}
gender_keep <- das_keep %>%
  left_join(gender_da, by = "DAUID") %>%
  st_transform(target_crs)
```

Build bbox from the ped layer

```{r}
bbox_sask_sf <- st_as_sfc(st_bbox(ped))  
```

Crop

```{r}
gender_keep <- st_make_valid(gender_keep) # fix any invalid geometries
gender_keep <- st_crop(gender_keep, bbox_sask_sf)
```

Plot 

```{r}
gender_da_map <- ggplot(gender_keep) +
  geom_sf(aes(fill = prop_women), color = NA) +
  scale_fill_distiller(
    type = "div", palette = "Reds", direction = -1,
    limits = c(0.40, 0.60), oob = squish,
    labels = percent_format(accuracy = 1),
    name = "Women (%)",
    na.value = "white"
  ) +
  coord_sf(xlim = st_bbox(ped)[c("xmin","xmax")],
           ylim = st_bbox(ped)[c("ymin","ymax")],
           expand = FALSE) +
  labs(title = "Proportion of Women by Dissemination Area",
       subtitle = "Saskatoon",
       caption = "Data: Statistics Canada, Census 2021") +
  theme_void() +
  theme(legend.position = "bottom",
        legend.title = element_text(size=8))

gender_da_map

ggsave("/Users/patysalazar/Desktop/Methods Café/Final Paper/plos_project/maps/gender_da_map.png",
       plot = gender_da_map, width = 8, height = 6, dpi = 300,
       bg = "white")
```

## 3. Mapping diabetes data (by DA and gender)

```{r}
health_data_path <- "/Users/patysalazar/Desktop/Methods Café/Final Paper/plos_project/required_files/Raw data for hospitalizations_for_Paty.xlsx"
```

Renaming variables

```{r}
health_data <- read_excel(
  path = health_data_path,
  sheet = "Diabetes"  
) %>%
  mutate(
    da = as.character(da),
    DAUID = da,
    gender_display = recode(gender,
                            "Male"   = "men",
                            "Female" = "women")
  )

names(health_data)
```


Overall cases by DA

```{r}
cases_da <- health_data %>%
  group_by(DAUID) %>%
  summarise(cases_all = n())

cases_da_gender <- health_data %>%
  filter(gender_display %in% c("men","women")) %>%
  count(DAUID, gender = gender_display, name = "cases") %>%
  ungroup()
```

Overall denominator for prevalence (per DA)

```{r}
den_all <- gender_da %>% select(DAUID, pop_all = total)
```

Gender-specific denominator for prevalence (per DA)

```{r}
den_gender <- gender_da %>%
  transmute(
    DAUID,
    men   = men_total,
    women = fem_total
  ) %>%
  pivot_longer(c(men, women), names_to="gender", values_to="pop")
```

Overall prevalence by DA

```{r}
prev_da <- cases_da %>%
  left_join(den_all, by = "DAUID") %>%
  mutate(prev_all = if_else(pop_all > 0, cases_all / pop_all, NA_real_))

prev_da
```

Gender-specific prevalence by DA

```{r}
prev_da_gender <- cases_da_gender %>%
  left_join(den_gender, by = c("DAUID","gender")) %>%
  mutate(prev = if_else(pop > 0, cases / pop, NA_real_))

prev_da_gender
```

Joining datasets by DA

```{r}
da_diabetes <- das_keep %>%
  left_join(health_data, by = "DAUID") 
```

Overall prevalence map

```{r}
da_diabetes_all <- das_keep %>%
  left_join(prev_da, by = "DAUID")

da_diabetes_plot <- ggplot(da_diabetes_all) +
  geom_sf(aes(fill = prev_all), color = NA) +
  scale_fill_viridis_c(labels = percent_format(accuracy = 0.1),
                       name = "Diabetes prevalence",
                       na.value = "white") +
  coord_sf(
    xlim = st_bbox(ped)[c("xmin","xmax")],
    ylim = st_bbox(ped)[c("ymin","ymax")],
    expand = FALSE
  ) +
  labs(title = "Diabetes Prevalence by DA (All)",
       subtitle = "Saskatoon") +
  theme_void() + theme(legend.position = "bottom")

ggsave("/Users/patysalazar/Desktop/Methods Café/Final Paper/plos_project/maps/diabetes_da_map.png",
       plot = da_diabetes_plot, width = 8, height = 6, dpi = 300,
       bg = "white")

da_diabetes_plot
```

Gender-specific maps

Splitting into 2 datasets

```{r}
# keep only men/women rows from gender-specific prevalence sf
da_diabetes_gender <- das_keep %>%                # <-- sf with geometry
  left_join(prev_da_gender, by = "DAUID") %>% # attach prev + gender
  st_make_valid()     

# common limits across both maps 
lims <- range(da_diabetes_gender$prev, na.rm = TRUE)
lims[1] <- 0
lims[2] <- max(lims[2], 0.15)   # 15% cap

# split
da_diabetes_men   <- da_diabetes_gender %>% filter(gender == "men")
da_diabetes_women <- da_diabetes_gender %>% filter(gender == "women")
```

Men map (diabetes by DA)

```{r}
p_men <- ggplot(da_diabetes_men) +
  geom_sf(aes(fill = prev), color = NA) +
  scale_fill_viridis_c(
    limits = lims, oob = squish,
    labels = percent_format(accuracy = 0.1),
    name = "Diabetes prevalence",
    na.value = "white"  
  ) +
  guides(fill = guide_colorbar(barheight = 0.6, barwidth = 12)) +
  coord_sf(
    xlim = st_bbox(ped)[c("xmin","xmax")],
    ylim = st_bbox(ped)[c("ymin","ymax")],
    expand = FALSE
  ) +
  labs(
    title = "Diabetes Prevalence by DA — Men",
    subtitle = "Saskatoon"
  ) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.title = element_text(size = 8))

print(p_men)

ggsave("/Users/patysalazar/Desktop/Methods Café/Final Paper/plos_project/maps/men_diabetes_da_map.png",
       plot = p_men, width = 8, height = 6, dpi = 300,
       bg = "white")
```

Women map (diabetes by DA)

```{r}
p_women <- ggplot(da_diabetes_women) +
  geom_sf(aes(fill = prev), color = NA) +
  scale_fill_viridis_c(
    limits = lims, oob = squish,
    labels = percent_format(accuracy = 0.1),
    name = "Diabetes prevalence",
    na.value = "white"
  ) +
  guides(fill = guide_colorbar(barheight = 0.6, barwidth = 12)) +
  coord_sf(
    xlim = st_bbox(ped)[c("xmin","xmax")],
    ylim = st_bbox(ped)[c("ymin","ymax")],
    expand = FALSE
  ) +
  labs(
    title = "Diabetes Prevalence by DA — Women",
    subtitle = "Saskatoon"
  ) +
  theme_void() +
  theme(legend.position = "bottom",
        legend.title = element_text(size = 8))

print(p_women)
ggsave("/Users/patysalazar/Desktop/Methods Café/Final Paper/plos_project/maps/women_diabetes_da_map.png",
       plot = p_women, width = 8, height = 6, dpi = 300,
       bg = "white")
```


## 4. Correlation analysis

```{r}
# walk scores code
final_data_path <- "/Users/patysalazar/Desktop/MSc/PLOS/plos/required_files/FINAL.xlsx"

final_scores <- read_excel(final_data_path) |>
  mutate(DAUID = as.character(DAUID))

names(final_scores)
```

Analysis data frame

```{r}
analysis_df <- final_scores %>%               
  select(DAUID, walk_rate, plos_density) %>%
  left_join(gender_da %>% select(DAUID, prop_women, total), by = "DAUID") %>%
  left_join(prev_da %>% select(DAUID, prev_all), by = "DAUID") %>%  
  mutate(
    plos_z        = as.numeric(scale(plos_density)),
    women_pct     = prop_women * 100
  )
summary(analysis_df)
```

Correlation walk rate & plos

```{r}
cor(final_scores$plos_density, final_scores$walk_rate)
```

Small positive correlation -> areas with better pedestrian infrastructure tend to have slightly higher walk rates, but it's weak.

Correlation walk rate & gender

```{r}
cor(analysis_df$prop_women, analysis_df$walk_rate, use = "complete.obs")
```

Weak correlation: 0.079.

Walk rate ~ gender model 

```{r}
# unweigthed
m0 <- lm(walk_rate ~ prop_women, data = analysis_df)
summary(m0)
```

Each 1.0 increase in the proportion of women is associated with a 0.15 increase in walk rate, but the association is not statistically significant.

```{r}
# weighted by DA population
m0w <- lm(walk_rate ~ prop_women, data = analysis_df, weights = total)
summary(m0w)
```

Slightly stronger when weighted by population, suggesting that larger DAs might show a clearer relationship between gender composition and walk rate. Almost statistically significant. 

Scatterplot

```{r}
ggplot(analysis_df, aes(x = prop_women, y = walk_rate)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = TRUE, color = "red") +
  scale_x_continuous(labels = percent_format(accuracy = 1)) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  labs(
    x = "Women proportion",
    y = "Walk rate",
    title = "Walk rate vs. gender by DA-level (Saskatoon)"
  ) +
  theme_minimal()
```

Diabetes correlations

```{r}
cor(analysis_df$walk_rate, analysis_df$prev_all, use = "complete.obs", method = "spearman")
cor(analysis_df$plos_density, analysis_df$prev_all, use = "complete.obs", method = "spearman")
```

## 5. Geographically weighted regression

```{r}
library(spgwr)
```

Converting analysis_df to spatial df by joining to polygons

```{r}
analysis_sf <- das_keep %>%
  left_join(
    analysis_df %>% select(DAUID, walk_rate, prop_women),
    by = "DAUID"
  ) %>%
  filter(!is.na(walk_rate), !is.na(prop_women)) %>%
  st_make_valid()

nrow(analysis_sf)
```

Converting to spatial object 

```{r}
analysis_sp <- as(analysis_sf, "Spatial")
```

Calculating kernel bandwidth 

```{r}
bw <- gwr.sel(walk_rate ~ prop_women, data = analysis_sp, coords=coordinates(analysis_sp))
```

Running GWR:

```{r}
gwr_model <- gwr(
  walk_rate ~ prop_women,
  data = analysis_sp,
  bandwidth = bw,
  coords = coordinates(analysis_sp),
  hatmatrix = TRUE,
  se.fit = TRUE
)
```

Printing results

```{r}
gwr_model
gwr_model$SDF$prop_women # sdf = spatial points data frame
```

Extracting coefficients

```{r}
analysis_sf$coef_women <- gwr_model$SDF$prop_women # extracting local coefficients for women proportion and attach to the polygons

summary(analysis_sf$coef_women)
```

Mapping coefficients

```{r}
gwr_map <- ggplot(analysis_sf) +
  geom_sf(aes(fill = coef_women), color = NA) +
  scale_fill_viridis_c(
    direction = 1,
    name = "Local coefficient:\nProportion women predicting walk rate",
    na.value = "white"
  ) +
  labs(
    title = "Geographically Weighted Regression Coefficients",
    subtitle = "Effect of proportion of women on walk rate by DA"
  ) +
  theme_void() +
  theme(legend.position = "bottom",
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

gwr_map
```







