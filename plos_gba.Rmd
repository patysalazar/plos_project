---
output:
  html_document:
    keep_md: true
---

#


## 0. Loading libraries & census dataset

```{r}
library(cancensus)
library(dplyr)
library(sf)
library(stringr)
library(purrr)
library(RColorBrewer)

dataset <- "CA21"
```

## 1. DA-level gender composition

```{r}
vecs <- c(
  total      = "v_CA21_1",
  male_0_14  = "v_CA21_12",
  fem_0_14   = "v_CA21_13",
  male_15_64 = "v_CA21_69",
  fem_15_64  = "v_CA21_70",
  male_65p   = "v_CA21_252",
  fem_65p    = "v_CA21_253"
)

sex_da_raw <- get_census(
  dataset    = "CA21",
  regions    = list(CMA = "47725"),
  level      = "DA",
  vectors    = unname(vecs),
  geo_format = NA,
  use_cache  = TRUE
)
```

```{r}
sex_da_std <- sex_da_raw %>%
  dplyr::rename(DAUID = GeoUID) %>%
  dplyr::rename_with(~ sub("^((v_CA21_\\d+)).*$", "\\1", .x))

# Optional sanity check: make sure the IDs we need are present
stopifnot(all(unname(vecs) %in% names(sex_da_std)))

# 2) Build totals and proportions
sex_da <- sex_da_std %>%
  dplyr::transmute(
    DAUID       = as.character(DAUID),
    total       = as.numeric(.data[[vecs["total"]]]),
    male_total  = as.numeric(.data[[vecs["male_0_14"]]])  +
                  as.numeric(.data[[vecs["male_15_64"]]]) +
                  as.numeric(.data[[vecs["male_65p"]]]),
    fem_total   = as.numeric(.data[[vecs["fem_0_14"]]])   +
                  as.numeric(.data[[vecs["fem_15_64"]]])  +
                  as.numeric(.data[[vecs["fem_65p"]]])
  ) %>%
  dplyr::mutate(
    prop_men   = dplyr::if_else(total > 0, male_total / total, NA_real_),
    prop_women = dplyr::if_else(total > 0, fem_total  / total, NA_real_)
  )

sex_da
```

```{r}
summary(sex_da$prop_women)
mean(sex_da$prop_women, na.rm=TRUE)
```


## Map gender

```{r}
ped_path <- "/Users/patysalazar/Desktop/MSc/PLOS/plos/required_files/Saskatoon_ped_1.shp"
ped <- st_read(ped_path, quiet = TRUE)
```

this is the plos code:


```{r}
ped_path <- "/Users/patysalazar/Desktop/MSc/PLOS/plos/required_files/Saskatoon_ped_1.shp"
da_path <- "/Users/patysalazar/Desktop/MSc/PLOS/plos/required_files/lda_000b21a_e/lda_000b21a_e.shp"
out_csv <- "/Users/patysalazar/Desktop/MSc/PLOS/plos/required_files/sk_da_plos_score.csv"
```

## 2.  Read layers 

```{r}
ped <- st_read(ped_path, quiet = TRUE)
da_poly <- st_read(da_path, quiet = TRUE) |>
  select(DAUID, PRUID, geometry) |>
  filter(PRUID == "47")  # keep Saskatchewan only
```
  
## 3.  Set Coordinate System

```{r}
ped <- st_transform(ped, crs = 3857) # projection -> Mercator
da_poly <- st_transform(da_poly, crs = 3857)
```

## 4.  Clean data 

```{r}
ped <- ped |>
  mutate(
    Walk_Width = ifelse(Walk_Width %in% c("99999", 99999, "<Null>"), NA, Walk_Width) |> as.numeric(),
    Walk_Mater = ifelse(Walk_Mater %in% c("<Null>", "0", 0, "9", 9), NA, Walk_Mater) |> as.integer()
  )
```


## 5.  Scoring functions 

```{r}
score_type <- function(x){
  case_when(
    x == "Walkway"  ~ 3,
    x == "Separate" ~ 3,
    x == "Pathway"  ~ 2,
    x == "Combined" ~ 1,
    TRUE            ~ 1
  )
}
```

```{r}
score_width <- function(w){
  case_when(
    is.na(w)  ~ 0,
    w <  1    ~ 0,
    w <  1.5  ~ 1,
    w <  2.5  ~ 2,
    w <  3    ~ 3,
    TRUE      ~ 4
  )
}
```

```{r}
score_material <- function(c){
  case_when(
    c %in% c(1, 2, 10) ~ 3,            # Concrete / Asphalt / Overlay
    c %in% c(3, 4)     ~ 2,            # Brick / Pavers
    c %in% c(5, 7)     ~ 1,            # Crusher Dust / Shale
    c == 6 | is.na(c)  ~ 0,            # Dirt or missing
    TRUE               ~ 0
  )
}
```


## 6.  Segment-level PLOS, normalised by DA area 

```{r}
ped_scored <- ped |>
  mutate(
    sc_type  = score_type(Walk_Type_),           
    sc_width = score_width(Walk_Width),
    sc_mat   = score_material(Walk_Mater),
    q_score  = sc_type + sc_width + sc_mat,      
    seg_km   = SHAPE_Leng / 1000,                
    wtd_val  = q_score * seg_km,
    density  = wtd_val / (LANDAREA)        
  )
```


## 7.  Aggregate density by DAUID 

```{r}
da_scores <- ped_scored |>
  st_drop_geometry() |>
  group_by(DAUID) |>
  summarise(plos_density = sum(density, na.rm = TRUE), .groups = "drop")
```


```{r}
library(sf)
library(dplyr)
library(ggplot2)
library(scales)

# 0) Target CRS = whatever ped is in (you already transformed ped to 3857)
target_crs <- st_crs(ped)

# 1) Make sure the DA layer is in the same CRS
das_cma <- das_cma_raw |>
  mutate(DAUID = as.character(.data[[id_col]])) |>
  st_transform(target_crs)

# 2) Keep only DAs you analyzed
das_keep <- das_cma |> filter(DAUID %in% keep_ids)

# 3) Join sex proportions (no geometry change) and ALIGN CRS again just in case
gender_keep <- das_keep |>
  left_join(sex_da, by = "DAUID") |>
  st_transform(target_crs)

# 4) Build bbox from the ped layer (guaranteed same CRS)
bbox_sask_sf <- st_as_sfc(st_bbox(ped))  # inherits ped's CRS

# 5) (Optional) fix any invalid geometries before spatial ops
gender_keep <- st_make_valid(gender_keep)

# 6) Crop
gender_keep <- st_crop(gender_keep, bbox_sask_sf)

# 7) Plot (matches your PLOS/walk-rate footprint)
ggplot(gender_keep) +
  geom_sf(aes(fill = prop_women), color = NA) +
  scale_fill_distiller(
    type = "div", palette = "Reds", direction = -1,
    limits = c(0.40, 0.60), oob = scales::squish,
    labels = percent_format(accuracy = 1),
    name = "Women (%)"
  ) +
  coord_sf(xlim = st_bbox(ped)[c("xmin","xmax")],
           ylim = st_bbox(ped)[c("ymin","ymax")],
           expand = FALSE) +
  labs(title = "Proportion of Women by Dissemination Area",
       subtitle = "Saskatoon",
       caption = "Data: Statistics Canada, Census 2021 (Sex at birth proxy)") +
  theme_void() +
  theme(legend.position = "bottom")

```


